/*! principalfish 21-02-2023 */
function seatExtended(a,b){this.name=a,this.current=b.seatInfo.current,this.majority=parseFloat((100*b.seatInfo.majority/b.seatInfo.turnout).toFixed(2));var c=lab=lib=ukip=green=oth="",d=0;$.each(b.partyInfo,function(a,e){"conservative"==a&&(c=parseFloat((100*e.total/b.seatInfo.turnout).toFixed(2))),"labour"==a&&(lab=parseFloat((100*e.total/b.seatInfo.turnout).toFixed(2))),"libdems"==a&&(lib=parseFloat((100*e.total/b.seatInfo.turnout).toFixed(2))),"ukip"==a&&(ukip=parseFloat((100*e.total/b.seatInfo.turnout).toFixed(2))),"green"==a&&(green=parseFloat((100*e.total/b.seatInfo.turnout).toFixed(2))),"other"==a&&(oth=parseFloat((100*e.total/b.seatInfo.turnout).toFixed(2))),partyMap[5].indexOf(a)!=-1&&(d+=e.total)}),this.con=c,this.lab=lab,this.lib=lib,this.ukip=ukip,this.green=green,this.oth=oth,this.nat=0==d?"":parseFloat((100*d/b.seatInfo.turnout).toFixed(2))}function getData(a){$.when($.getJSON(a.mapurl,function(b){a.polygons=b}),$.getJSON(a.dataurl,function(b){a.seatData=b,currentMap=a}),$.getJSON(a.previous,function(b){a.previousSeatData=b})).then(function(){pageLoadEssentials()})}function pageLoadEssentials(){mapAttr.loadmap(currentMap),filters.opacities={},filters.reset(),params.checkParams(),$("#userinput-table input").each(function(){this.value=0}),userInput.inputs={};var a=Object.keys(currentMap.seatData);a.sort(),$(function(){$("#searchseats").autocomplete({source:a,select:function(a,b){searchSeats(b.item.label)}})}),$("#predictbutton").addClass("hidden"),uiAttr.pageLoadDiv(),"election2017"!=currentMap.name&&"prediction"!=currentMap.name?$("#instructions").remove():$(function(){$("#lastpollster").load("lastpollster.html")}),1==currentMap.election?$("#filter-byElection").text("Gains"):0==currentMap.election&&$("#filter-byElection").text("By-Elections"),"election2010"==currentMap.name||"2017-600seat"==currentMap.name?$("#filter-byElection").hide():$("#filter-byElection").show(),currentMap.seatDataBackup=jQuery.extend(!0,{},currentMap.seatData),1==currentMap.predict&&(userInput.seatDataCopy=jQuery.extend(!0,{},currentMap.seatData)),"2017-600seat"==currentMap.name||"prediction-600seat"==currentMap.name?$("#seat-600 ").show():$("#seat-600 ").hide(),0==currentMap.battlegrounds?$("#battlegrounds").hide():$("#battlegrounds").show(),0==currentMap.redistribute&&$("#redistribute").hide(),navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&($("div").css("font-size","98%"),$("select").css("font-size","98%")),"myprediction"==currentMap.name?$("#myprediction").show():$("#myprediction").hide()}function searchSeats(a){mapAttr.clicked(currentMap.seatData[a].mapSelect)}function pageSetting(a,b,c,d,e,f,g,h){this.name=a,this.mapurl=b,this.dataurl=c,this.previous=d,this.election=e,this.predict=f,this.battlegrounds=g,this.redistribute=h,this.seatData={},this.previousSeatData={},this.polygons={}}function initialization(){var a=getParameterByName("map",url),b=urlParamMap[a];uiAttr.changeNavBar(b.name),$(".map").remove(),$(document).ready(function(){getData(b)})}function getParameterByName(a,b){b||(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");var c=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)"),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null}function activeSeat(a){this.name=a;var b=currentMap.seatData[a].seatInfo,c=currentMap.seatData[a].partyInfo;this.region=b.region,this.current=b.current,this.previous=currentMap.previousSeatData[a].seatInfo.current,this.electorate=b.electorate,this.turnout=b.turnout.toFixed(0)/1,this.majority=b.majority,this.byElection=b.byElection,this.votes=[];var d=currentMap.previousSeatData[a].partyInfo,e=0;$.each(d,function(a,b){e+=b.total});for(var f in c)if(c[f].total>0){var g;if(f in d){var h=d[f].total;g=(100*h/e).toFixed(2)}else g=0;partyData=c[f];var i=(100*partyData.total/this.turnout).toFixed(2),j=(i-g).toFixed(2);if("other"==f||"others"==f)var j="0";this.votes.push({party:f,name:partyData.name,totalPercentage:i,previousTotalPercentage:g,change:j})}this.votes.sort(function(a,b){return b.totalPercentage-a.totalPercentage})}var battleground={active:!1,incumbent:"null",challenger:"null",region:"null",low:0,high:10,handle:function(a,b){a=a.substring(14),"incumbent"==a?battleground.incumbent=b:"challenger"==a?battleground.challenger=b:"region"==a?battleground.region="null"==b?"null":"england"==b?regionMap.england:[b]:"majlow"==a?isNaN(parseFloat(b))||(parseFloat(b)<0&&(b=0),battleground.low=parseFloat(b)):"majhigh"==a&&(isNaN(parseFloat(b))||(parseFloat(b)>100&&(b=100),battleground.high=parseFloat(b))),battleground.check()},check:function(){"null"!=battleground.incumbent&&"null"!=battleground.challenger?(filters.reset(),battleground.incumbent!=battleground.challenger&&battleground.filter()):filters.reset()},filter:function(){if("election2017"==currentMap.name)var a=currentMap.seatData;else var a=currentMap.previousSeatData;$.each(currentMap.seatData,function(b,c){if(a[b].seatInfo.current!=battleground.incumbent)c.filtered=!1;else{var d=a[b].seatInfo.current;if(battleground.challenger in a[b].partyInfo){var e=a[b].partyInfo[d].total,f=a[b].partyInfo[battleground.challenger].total,g=a[b].seatInfo.turnout,h=100*(e/g-f/g);battleground.low<=h&&h<=battleground.high?c.filtered=!0:c.filtered=!1}else c.filtered=!1}if("null"!=battleground.region){var i=a[b].seatInfo.region;battleground.region.indexOf(i)==-1&&(c.filtered=!1)}0==c.filtered?filters.opacities[b]=.05:filters.opacities[b]=1}),filters.display()}},choro={choroTypes:["choro-voteshare","choro-votesharechange","swing"],handle:function(a,b){if($.each(choro.choroTypes,function(b,c){c!=a&&$("#"+c+" option:eq(0)").prop("selected",!0)}),a=a.slice(6),"null"!=b){var c=choro.minmax(a,b);choro.opacities(c,a,b),choro.applyClass(a,b),filters.changeSnpBorders(),filters.display(),choro.keyOnMap(c,a,b)}else filters.filter()},minmax:function(a,b){var c=0;return $.each(currentMap.seatData,function(d,e){if(1==e.filtered)if("voteshare"==a)b in e.partyInfo&&e.partyInfo[b].total/e.seatInfo.turnout>c&&(c=e.partyInfo[b].total/e.seatInfo.turnout);else if("votesharechange"==a){var f=0,g=0;b in e.partyInfo&&(f=e.partyInfo[b].total/e.seatInfo.turnout),b in currentMap.previousSeatData[d].partyInfo&&(g=currentMap.previousSeatData[d].partyInfo[b].total/currentMap.previousSeatData[d].seatInfo.turnout);var h=f-g;Math.abs(h)>c&&(c=Math.abs(h))}}),c>.6&&(c=.6),c},opacities:function(a,b,c){$.each(currentMap.seatData,function(d,e){var f=0;if(1==e.filtered&&0!=a)if("voteshare"==b)c in e.partyInfo&&(f=e.partyInfo[c].total/(e.seatInfo.turnout*a));else if("votesharechange"==b){var g=0,h=0;c in e.partyInfo&&(g=e.partyInfo[c].total/e.seatInfo.turnout),c in currentMap.previousSeatData[d].partyInfo&&(h=currentMap.previousSeatData[d].partyInfo[c].total/currentMap.previousSeatData[d].seatInfo.turnout);var i=g-h;f=i/a}f>1&&(f=1),filters.opacities[d]=f,e.mapSelect.opacity=f})},applyClass:function(a,b){"voteshare"==a?$.each(currentMap.seatData,function(a,c){$("#i"+c.mapSelect.properties.info_id).removeClass(),$("#i"+c.mapSelect.properties.info_id).addClass("map "+b)}):"votesharechange"==a&&$.each(currentMap.seatData,function(a,b){$("#i"+b.mapSelect.properties.info_id).removeClass(),filters.opacities[a]<0?($("#i"+b.mapSelect.properties.info_id).addClass("map choro-minus"),filters.opacities[a]=Math.abs(filters.opacities[a]),b.mapSelect.opacity=Math.abs(b.mapSelect.opacity)):$("#i"+b.mapSelect.properties.info_id).addClass("map choro-plus")})},keyOnMap:function(a,b,c){$("#keyonmap").empty(),$("#keyonmap").show();var d;"voteshare"==b?d=$("."+c).css("background-color"):"votesharechange"==b&&(d="rgb(0, 0, 255)",c="choro-plus");var e=100*a/5;if("votesharechange"==b)for(var f=5;f>0;f--){var g="rgba(255, 0, 0, "+.2*f+")",h="<div class='choro-minus' style='background-color: "+g+"'>-"+(f*e).toFixed(1)+"%";.6==a&&5==f&&(h+="+"),h+="</div>",$("#keyonmap").append(h)}for(var f=0;f<6;f++){var g=d.replace(")",","+.2*f+")").replace("rgb","rgba"),h="<div class='"+c+"' style='background-color:"+g+"'>"+(f*e).toFixed(1)+"%";.6==a&&5==f&&(h+="+"),h+="</div>",$("#keyonmap").append(h)}},reset:function(){$("#keyonmap").hide(),$.each(currentMap.seatData,function(a,b){$("#i"+b.mapSelect.properties.info_id).removeClass(),$("#i"+b.mapSelect.properties.info_id).addClass("map "+b.seatInfo.current)}),$("#choro-voteshare option:eq(0)").prop("selected",!0),$("#choro-votesharechange option:eq(0)").prop("selected",!0)}},partylist={};partylist.labour="Labour",partylist.conservative="Conservative",partylist.libdems="Lib Dems",partylist.snp="SNP",partylist.ukip="Brexit Party",partylist.plaidcymru="Plaid Cymru",partylist.green="Green",partylist.uu="UUP",partylist.sinnfein="Sinn FÃ©in",partylist.sdlp="SDLP",partylist.dup="DUP",partylist.alliance="Alliance",partylist.other="Other",partylist.others="Others";var partyMap=[["conservative"],["labour"],["libdems"],["ukip"],["green"],["snp","plaidcymru","uu","dup","alliance","sdlp","sinnfein"],["other"]],partyToRegion={scotland:["conservative","labour","libdems","ukip","green","snp","other","others"],wales:["conservative","labour","libdems","ukip","green","plaidcymru","other","others"],northernireland:["dup","sinnfein","uu","sdlp","alliance","other","others"],default:["conservative","labour","libdems","ukip","green","other","others"]},regionlist={};regionlist.london="London",regionlist.southeastengland="S.E. England",regionlist.southwestengland="S. W. England",regionlist.westmidlands="W. Midlands",regionlist.northwestengland="N. W. England",regionlist.northeastengland="N. E. England",regionlist.yorkshireandthehumber="Yorks & Humber",regionlist.eastmidlands="E. Midlands",regionlist.eastofengland="E. England",regionlist.scotland="Scotland",regionlist.wales="Wales",regionlist.northernireland="N. Ireland",regionlist.unitedkingdom="United Kingdom",regionlist.greatbritain="Great Britain",regionlist.england="England";var regionMap={unitedkingdom:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london","scotland","wales","northernireland"],greatbritain:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london","scotland","wales"],england:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london"]},seatsPerRegion2015={northeastengland:{labour:26,conservative:3},northwestengland:{labour:54,conservative:20,libdems:1},yorkshireandthehumber:{labour:37,conservative:17,libdems:0},southeastengland:{conservative:72,labour:8,green:1,libdems:2,others:1},southwestengland:{conservative:47,labour:7,libdems:1},eastofengland:{conservative:50,labour:7,libdems:1,ukip:0},eastmidlands:{conservative:31,labour:15},westmidlands:{conservative:35,labour:24},london:{labour:49,conservative:21,libdems:3},scotland:{snp:35,conservative:13,labour:7,libdems:4},wales:{labour:28,conservative:8,libdems:0,plaidcymru:4},northernireland:{uu:0,dup:10,sdlp:0,sinnfein:7,others:1}},filters={state:{majority:[0,100]},selectHandle:function(a,b){a=a.substring(7),"null"==b?delete filters.state[a]:"region"==a&&"england"==b?filters.state.region=regionMap.england:filters.state[a]=b,filters.filter()},byElection:function(a){0==currentMap.election&&(""==a?($("#filter-byElection").addClass("filter-button-active"),filters.state.byElection=!0):"filter-button-active"==a&&($("#filter-byElection").removeClass("filter-button-active"),delete filters.state.byElection)),1==currentMap.election&&(""==a?($("#filter-byElection").addClass("filter-button-active"),filters.state.gains=!0):"filter-button-active"==a&&($("#filter-byElection").removeClass("filter-button-active"),delete filters.state.gains)),filters.filter()},majority:function(a,b){"low"==a?filters.state.majority[0]=b:"high"==a&&(filters.state.majority[1]=b),filters.filter()},opacities:{},filter:function(){choro.reset(),$.each(currentMap.seatData,function(a,b){var c=!0;$.each(filters.state,function(d,e){if("majority"==d){var f=100*b.seatInfo.majority/b.seatInfo.turnout;(f<filters.state.majority[0]||f>filters.state.majority[1])&&(c=!1)}else"byElection"==d?void 0==b.seatInfo.byElection&&(c=!1):"gains"==d?b.seatInfo.current==currentMap.previousSeatData[a].seatInfo.current&&(c=!1):e.indexOf(b.seatInfo[d])==-1&&(c=!1)}),1==c?(filters.opacities[a]=1,b.filtered=!0):(filters.opacities[a]=.05,b.filtered=!1)}),filters.changeSnpBorders(),filters.display()},display:function(){$.each(filters.opacities,function(a,b){var c=currentMap.seatData[a].mapSelect;c.opacity=b,d3.select("#i"+c.properties.info_id).attr("opacity",b)}),filters.getSeatlist()},reset:function(){filters.state={majority:[0,100]},$("#filter-current option:eq(0)").prop("selected",!0),$("#filter-region option:eq(0)").prop("selected",!0),$(".filter-button-active").removeClass("filter-button-active"),$("#filter-majority").get(0).reset(),$("#selectareatotals option:eq(0)").prop("selected",!0),voteTotals.calculate("unitedkingdom"),voteTotals.getMajority(),$("#seatlist-sort"+filters.activeSort).removeClass("sort-active"),filters.activeSort="name",$("#seatlist-sortname").addClass("sort-active"),filters.filter()},changeSnpBorders:function(){$(".map").each(function(a,b){var c=$(b).attr("class");["map snp","map libdems","map green","map sdlp"].indexOf(c)!=-1&&$(b).addClass("mapdark")})},filteredList:[],getSeatlist:function(){$("#seatlist-container").empty(),uiAttr.hideDiv("seatlist-extend"),filters.filteredList=[],$.each(currentMap.seatData,function(a,b){1==b.filtered&&filters.filteredList.push(new seatExtended(a,b))}),filters.sortState={name:"asc",current:"asc",majority:"desc",con:"desc",lab:"desc",lib:"desc",ukip:"desc",green:"desc",nat:"desc",oth:"desc"},filters.reorder("name","asc","simple")},activeSort:"name",sortState:{},tableSort:function(a){a=a.slice(13),$("#seatlist-sort"+filters.activeSort).removeClass("sort-active"),filters.activeSort=a,$("#seatlist-sort"+filters.activeSort).addClass("sort-active"),filters.reorder(a,filters.sortState[a],"extended"),"desc"==filters.sortState[a]?filters.sortState[a]="asc":"asc"==filters.sortState[a]&&(filters.sortState[a]="desc")},reorder:function(a,b,c){var d=filters.filteredList.map(function(a,b){return{ind:b,data:a}});"asc"==b&&d.sort(function(b,c){return b.data[a]<c.data[a]?-1:b.data[a]>c.data[a]?1:b.ind-c.ind}),"desc"==b&&d.sort(function(b,c){return b.data[a]<c.data[a]?1:b.data[a]>c.data[a]?-1:b.ind-c.ind}),filters.filteredList=d.map(function(a){return a.data}),"simple"==c&&filters.simpleList(),"extended"==c&&filters.extendedList()},simpleList:function(){$("#seatlist-total").text(filters.filteredList.length),$.each(filters.filteredList,function(a,b){var c="<div class='extended-seat' onclick='mapAttr.clicked(currentMap.seatData[\""+b.name+"\"].mapSelect)'><div class='party-flair "+b.current+"'></div>"+b.name+"</div>";$("#seatlist-container").append(c)})},extendedList:function(){$("#seatlist-extended-data").empty(),uiAttr.hideDiv("seatlistbutton"),$.each(filters.filteredList,function(a,b){var c=b.name,d="<div style='margin-left: 10px' class='party-flair "+b.current+"'></div>";currentMap.previousSeatData[b.name].seatInfo.current!=b.current&&(d+=" <span style='font-weight: bold'>GAIN</span>");var e="<div><div class='extended-seat' onclick='mapAttr.clicked(currentMap.seatData[\""+b.name+"\"].mapSelect)'>"+c+"</div><div>"+d+"</div><div>"+b.majority.toFixed(2),f=[b.con,b.lab,b.lib,b.ukip,b.green,b.nat,b.oth];$.each(partyMap,function(a,c){var d=filters.getChange(b.name,partyMap[a],f[a]);e+=c.indexOf(b.current)!=-1?"</div><div style='font-weight: bold;"+d+"'>"+f[a]:"</div><div style='"+d+"'>"+f[a]}),e+="</div></div>",$("#seatlist-extended-data").append(e)})},getChange:function(a,b,c){var d=0;return $.each(b,function(b,c){c in currentMap.previousSeatData[a].partyInfo&&(d+=currentMap.previousSeatData[a].partyInfo[c].total)}),d=(100*d/currentMap.previousSeatData[a].seatInfo.turnout).toFixed(2),c>d?"color: green":d>c?"color: red":""}},mapAttr={width:600,height:875,active:d3.select(null),activeNode:null,clicked:function(a){mapAttr.activeNode=a,mapAttr.flashSeat(a);var b=path.bounds(a),c=Math.pow(b[1][0]-b[0][0],.5),d=Math.pow(b[1][1]-b[0][1],.5),e=(b[0][0]+b[1][0])/2,f=(b[0][1]+b[1][1])/2,g=.05/Math.max(c/mapAttr.width,d/mapAttr.height),h=[mapAttr.width/2-g*e,mapAttr.height/2-g*f];mapAttr.disableZoom(),svg.transition().duration(1500).call(zoom.transform,d3.zoomIdentity.translate(h[0],h[1]).scale(g)).on("end",mapAttr.enableZoom),uiAttr.showDiv("seat-information"),seatInfoTable.display(a.properties.name)},flashSeat:function(a){function b(){current.transition().duration(1500).attr("opacity",.02).transition().duration(1500).attr("opacity",a.opacity).on("end",b)}var c="#i"+a.properties.info_id;current=d3.select(c),b()},disableZoom:function(){svg.on("mousedown.zoom",null),svg.on("mousemove.zoom",null),svg.on("dblclick.zoom",null),svg.on("touchstart.zoom",null),svg.on("wheel.zoom",null),svg.on("mousewheel.zoom",null),svg.on("MozMousePixelScroll.zoom",null)},enableZoom:function(){svg.call(zoom)},reset:function(){null!=mapAttr.activeNode&&d3.select("#i"+mapAttr.activeNode.properties.info_id).transition().attr("opacity",mapAttr.activeNode.opacity),mapAttr.activeNode=null,mapAttr.disableZoom(),svg.transition().duration(1500).call(zoom.transform,d3.zoomIdentity).on("end",function(){mapAttr.enableZoom()})},zoomed:function(){g.style("stroke-width",1.5/d3.event.scale+"px"),g.attr("transform",d3.event.transform)},stopped:function(){d3.event.defaultPrevented&&d3.event.stopPropagation()},loadmap:function(a){g.selectAll(".map").data(topojson.feature(a.polygons,a.polygons.objects.map).features).enter().append("path").attr("class",function(b){var c;if(b.properties.name in a.seatData)var c=a.seatData[b.properties.name].seatInfo.current;return b.properties.name in a.seatData&&"snp"==c?"mapdark snp":b.properties.name in a.seatData?"map "+c:"null"}).attr("opacity",1).attr("id",function(a){return"i"+a.properties.info_id}).attr("d",path).on("click",mapAttr.clicked).append("svg:title").text(function(a){return a.properties.name}).each(function(b){if(b.properties.name in currentMap.seatData){a.seatData[b.properties.name].mapSelect=b,a.seatData[b.properties.name].mapSelect.opacity=1,filters.opacities[b.properties.name]=1,a.seatData[b.properties.name].filtered=!0;var c=0;for(var d in a.seatData[b.properties.name].partyInfo)c+=a.seatData[b.properties.name].partyInfo[d].total;a.seatData[b.properties.name].seatInfo.turnout=c;var e=0;for(var d in a.previousSeatData[b.properties.name].partyInfo)e+=a.previousSeatData[b.properties.name].partyInfo[d].total;a.previousSeatData[b.properties.name].seatInfo.turnout=e}}),g.append("path").datum(topojson.mesh(a.polygons,a.polygons.objects.map,function(a,b){return a.properties.region!=b.properties.region&&a!=b})).attr("d",path).attr("class","boundaries")}},projection=d3.geoAlbers().center([-.5,54.4]).rotate([2.25,0]).parallels([51,60]).scale(5300).translate([mapAttr.width/2,mapAttr.height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",mapAttr.zoomed),currentMap,dataurls={map650:"650map.json",map600:"600map.json",predict:"houseofcommons/prediction.json",current:"houseofcommons/current.json",e2019:"houseofcommons/2019election.json",e2017:"houseofcommons/2017election.json",e2015:"houseofcommons/2015election.json",e2010:"houseofcommons/2010election.json",e2017_600:"houseofcommons/2017election_600seat.json",predict_600:"houseofcommons/prediction_600seat.json"},currentParliament=new pageSetting("current",dataurls.map650,dataurls.current,dataurls.e2019,!1,!1,!1,!1),election2019=new pageSetting("election2019",dataurls.map650,dataurls.e2019,dataurls.e2017,!0,!1,!0,!1),election2017=new pageSetting("election2017",dataurls.map650,dataurls.e2017,dataurls.e2015,!0,!1,!0,!1),election2015=new pageSetting("election2015",dataurls.map650,dataurls.e2015,dataurls.e2010,!0,!1,!1,!1),election2010=new pageSetting("election2010",dataurls.map650,dataurls.e2010,dataurls.e2010,!1,!1,!1,!1),prediction=new pageSetting("prediction",dataurls.map650,dataurls.predict,dataurls.e2019,!0,!1,!0,!1),predictit=new pageSetting("predictit",dataurls.map650,dataurls.e2019,dataurls.e2019,!0,!0,!0,!1),election2017_600seat=new pageSetting("2017-600seat",dataurls.map600,dataurls.e2017_600,dataurls.e2017_600,!1,!1,!1,!1),prediction_600seat=new pageSetting("prediction-600seat",dataurls.map600,dataurls.predict_600,dataurls.e2017_600,!0,!1,!1,!1),predictit_2015=new pageSetting("prediction_2015",dataurls.map650,dataurls.e2015,dataurls.e2015,!0,!0,!0,!1),url=window.location.href,urlParamMap={null:prediction,current:currentParliament,prediction:prediction,predictit:predictit,election2019:election2019,election2017:election2017,election2015:election2015,election2010:election2010,election2017_600seat:election2017_600seat,prediction_600seat:prediction_600seat,predictit_2015:predictit_2015},params={possibleFilterParams:["incumbent","region","majlow","majhigh","gains","byelection"],possibleBattlegroundParams:["incumbent","challenger","region","majlow","majhigh"],checkParams:function(){params.filters()},filters:function(){var a=!1;return $.each(params.possibleFilterParams,function(b,c){var d=getParameterByName(c,url);null!=d&&(d=d.toLowerCase(),"incumbent"==c?filters.selectHandle("filter-current",d):"region"==c?filters.selectHandle("filter-region",d):"majlow"==c?filters.majority("low",d):"majhigh"==c?filters.majority("high",d):"gains"!=c&&"byelection"!=c||"yes"!=d&&"true"!=d||filters.byElection(""),a=!0)}),1==a},battleground:function(){if(1==currentMap.battlegrounds){var a=!1;$.each(params.possibleBattlegroundParams,function(b,c){var d=getParameterByName(c,url);null!=d&&(a=!0,battleground.handle("battlegrounds-"+c,d))})}}},redistribute={active:!1,validInput:!0,ukip:!1,green:!1,values:{ukip:{conservative:0,labour:0,libdems:0,notVoting:100},green:{conservative:0,labour:0,libdems:0,notVoting:100}},check:function(a,b,c){valueInt=parseInt(c),Number.isInteger(valueInt)?this.values[a][b]=valueInt:this.values[a][b]=0;var d=(this.values[a].notVoting,this.values[a].conservative+this.values[a].labour+this.values[a].libdems);this.values[a].notVoting=100-d;var e=this.values[a].notVoting;this.validInput=!0,e<0&&(e="<0",this.validInput=!1),$("#redist-"+a+"-notvoting").text(e),100!=this.values[a].notVoting?this[a]=!0:this[a]=!1},handle:function(){this.validInput?(this.reset(),$.each(this.values,function(a,b){1==redistribute[a]&&$.each(currentMap.seatData,function(c,d){a in d.partyInfo&&0==d.partyInfo[a].standing&&redistribute.calculate(d,a,b)})}),filters.reset()):alert("Percentages add up to more than 100!")},calculate:function(a,b,c){var d=a.partyInfo[b].total;a.seatInfo.turnout-=d*c.notVoting/100,a.seatInfo.turnout=Math.round(a.seatInfo.turnout),$.each(c,function(b,c){b in a.partyInfo&&(a.partyInfo[b].total+=c*d/100,a.partyInfo[b].total=Math.round(a.partyInfo[b].total))}),delete a.partyInfo[b];var e=null,f=0,g=[];$.each(a.partyInfo,function(a,b){g.push(b.total),b.total>f&&(f=b.total,e=a)}),g.sort(function(a,b){return b>a}),a.seatInfo.current=e,a.seatInfo.majority=g[0]-g[1]},reset:function(){currentMap.seatData=jQuery.extend(!0,{},currentMap.seatDataBackup),filters.reset()},resetInputs:function(){$("#redist-table").find("input:text").val(0),$("#redist-ukip-notvoting").text("100"),$("#redist-green-notvoting").text("100"),this.green=!1,this.ukip=!1,this.values={ukip:{conservative:0,labour:0,libdems:0,notVoting:100},green:{conservative:0,labour:0,libdems:0,notVoting:100}},this.reset()}},seatInfoTable={party:null,gain:null,display:function(a){var b=new activeSeat(a);seatInfoTable.seatInfo(b),seatInfoTable.voteTable(b.votes),seatInfoTable.barChart(b.votes)},seatInfo:function(a){$("#information-party .party-flair").removeClass(seatInfoTable.party),$("#information-gain .party-flair").removeClass(seatInfoTable.gain),void 0!=a.byElection?(a.name+="*",$("#information-byelection").text("*By-election on "+a.byElection)):$("#information-byelection").text(""),$("#information-seatname-span").text(a.name),$("#information-region").text(regionlist[a.region]),$("#information-party .party-name").text(partylist[a.current]),$("#information-party .party-flair").addClass(a.current),a.current!=a.previous?($("#information-gain .party-name").text("FROM "+partylist[a.previous]),$("#information-gain .party-flair").addClass(a.previous)):$("#information-gain .party-name").text("");var b=(100*a.majority/a.turnout).toFixed(2);$("#information-majority").text("Majority: "+b+"% = "+a.majority);var c=(100*a.turnout/a.electorate).toFixed(2);$("#information-turnout").text("Turnout : "+a.turnout+" = "+c+"%"),seatInfoTable.party=a.current,seatInfoTable.gain=a.previous},barChart:function(a){$("#information-bar").empty();for(var b=[],c=0;c<a.length;c++)a[c].totalPercentage>5&&b.push(a[c]);a=b;var d=a.length,e={top:10,right:0,bottom:10,left:25},f=200-e.left-e.right,g=200-e.top-e.bottom,h=d3.min([60,f/d-2]),i=d3.select("#information-bar").append("svg").attr("width",f+e.left+e.right).attr("height",g+e.top+e.bottom).append("g").attr("transform","translate("+e.left+","+e.top+")"),j=d3.scaleOrdinal().range([0,d*(h+2)]),k=d3.axisBottom().scale(j),l=d3.scaleLinear().range([g,0]),m=d3.axisLeft().scale(l).ticks(6),n=d3.max(a,function(a){return a.totalPercentage/1});l.domain([0,d3.max([60,n+(10-n%10)])]),i.append("g").attr("class","x axis").attr("transform","translate(0,"+g+")").call(k),i.append("g").attr("class","y axis").call(m),i.selectAll("rect").data(a).enter().append("rect").attr("x",function(a,b){return 2*(b+1)+h*b}).attr("width",h).attr("y",g).attr("height",0).attr("class",function(a){return a.party}).transition().delay(function(a,b){return 250*b/2}).duration(250).attr("y",function(a){return l(a.totalPercentage)}).attr("height",function(a){return g-l(a.totalPercentage)})},voteTable:function(a){$("#information-chart").empty();for(var b=0;b<a.length;b++){var c="<div class='party-info-table'>";c+="<div class='party-flair "+a[b].party+"'></div>",c+="<div>"+a[b].name+"</div>";var d,e="";0!=a[b].change&&(e="("+a[b].change+")",d=a[b].change>0?"green":"red",e="<span style='color: "+d+";'>"+e+"</span>"),c+="<div>"+a[b].totalPercentage+"% "+e+"</div>",c+="</div>",$("#information-chart").append(c)}}},uiAttr={changeNavBar:function(a){$(".navbaractive").removeClass("navbaractive");var b="#nav-"+a;$(b).addClass("navbaractive");var c=$(b).text();$("#pagetitle").html(c),document.title=c},clickMapButton:function(a){var b=$(a).attr("class"),c=$(a).attr("id");b.indexOf("mapbuttonactive")==-1?($(a).addClass("mapbuttonactive"),uiAttr.showDiv(c)):uiAttr.hideDiv(c)},showDiv:function(a){uiAttr.zIndexCheck(a),"battlegrounds"==a&&(battleground.active=!0),"redistribute"==a&&(redistribute.active=!0),$(uiAttr.buttonToDiv[a]).show(),$(uiAttr.buttonToDiv[a]).mousedown(function(){uiAttr.zIndexCheck(a),uiAttr.zIndexShuffle()}).draggable({handle:"h2",containment:"#wrapper"}),uiAttr.zIndexShuffle()},hideDiv:function(a){var b=uiAttr.zIndexTracker.indexOf(a);$("#"+a).removeClass("mapbuttonactive"),"battlegrounds"==a&&(battleground.active=!1),"redistribute"==a&&(redistribute.active=!1),b!=-1&&uiAttr.zIndexTracker.splice(b,1),$(uiAttr.buttonToDiv[a]).hide(),uiAttr.zIndexShuffle()},buttonToDiv:{"seat-information":"#seat-information",votetotalsbutton:"#votetotals",filtersbutton:"#filters",choroplethsbutton:"#choropleths",seatlistbutton:"#seatlist","seatlist-extend":"#seatlist-extended",predictbutton:"#userinput","seat-600":"#seat-600",battlegrounds:"#battlegroundsselect",redistribute:"#redistributeselect"},zIndexTracker:[],zIndexCheck:function(a){if(uiAttr.zIndexTracker.indexOf(a)==-1)uiAttr.zIndexTracker.push(a);else{var b=uiAttr.zIndexTracker.indexOf(a),c=uiAttr.zIndexTracker.length-1;uiAttr.zIndexTracker.splice(b,1),uiAttr.zIndexTracker.splice(c,0,a)}},zIndexShuffle:function(){for(var a=uiAttr.zIndexTracker,b=0;b<a.length;b++)$(uiAttr.buttonToDiv[a[b]]).css("z-index",b+1)},pageLoadDiv:function(a){$.each(uiAttr.buttonToDiv,function(a,b){"votetotalsbutton"==a||"filtersbutton"==a||"choroplethsbutton"==a||"seatlistbutton"==a?uiAttr.showDiv(a):"predictbutton"==a&&1==currentMap.predict?($("#predictbutton").removeClass("hidden").addClass("mapbuttonactive"),uiAttr.showDiv(a)):battleground.active?uiAttr.showDiv("battlegroundsbutton"):redistribute.active?uiAttr.showDiv("redistributebutton"):uiAttr.hideDiv(a)})}},userInput={seatDataCopy:{},advancedDivs:regionMap.england,showAdvanced:function(){delete userInput.inputs.england,$("#userinput").css("top","400px"),$("#userinput-england").addClass("hidden"),$("#userinput-england input").each(function(){this.value=0}),$("#userinput-show").addClass("hidden"),$("#userinput-hide").removeClass("hidden"),$.each(userInput.advancedDivs,function(a,b){$("#userinput-"+b).removeClass("hidden")})},hideAdvanced:function(){$("#userinput").css("top","577px"),$.each(userInput.advancedDivs,function(a,b){delete userInput.inputs[b]}),$("#userinput-england").removeClass("hidden"),$("#userinput-show").removeClass("hidden"),$("#userinput-hide").addClass("hidden"),$.each(userInput.advancedDivs,function(a,b){$("#userinput-"+b).addClass("hidden"),$("#userinput-"+b+" input").each(function(){this.value=0})})},inputs:{},over100:!1,check:function(a,b,c){a in userInput.inputs||(userInput.inputs[a]={}),(""==c||c<0)&&(c=0),userInput.inputs[a][b]=Math.round(100*parseFloat(c))/100;var d=0,e=0;$.each(userInput.inputs[a],function(a,b){d+=b,b>e&&(e=b)}),0==e&&delete userInput.inputs[a],d>100?($("#userinput-"+a+"-other").text("<0"),userInput.over100=!0):($("#userinput-"+a+"-other").text(100-d),userInput.over100=!1)},handle:function(){1==userInput.over100?alert("Some percentages add up to more than 100!"):($.each(userInput.inputs,function(a,b){var c=0;if("scotland"==a)for(var d=partyToRegion.scotland,e=0;e<d.length;e++)d[e]in b||(b[d[e]]=0),c+=b[d[e]];else if("wales"==a)for(var d=partyToRegion.wales,e=0;e<d.length;e++)d[e]in b||(b[d[e]]=0),c+=b[d[e]];else if("northernireland"==a)for(var d=partyToRegion.northernireland,e=0;e<d.length;e++)d[e]in b||(b[d[e]]=0),c+=b[d[e]];else for(var d=partyToRegion.default,e=0;e<d.length;e++)d[e]in b||(b[d[e]]=0),c+=b[d[e]];c=100-c,b.other=c,delete b.others,userInput.calculate(a,b),delete b.other}),$(".map").remove(),mapAttr.loadmap(currentMap),filters.reset(),uiAttr.pageLoadDiv())},calculate:function(a,b){var c=userInput.getOldTotals(a),d=c[0],e=c[1],f=userInput.getUserChange(b,d,e);userInput.seatAnalysis(f,e)},getOldTotals:function(a){if(a in regionMap)var b=regionMap[a];else var b=[a];var c;c=["scotland","wales","northernireland"].indexOf(a)!=-1?partyToRegion[a]:partyToRegion.default;for(var d=0,e={},f={totals:{}},g=0;g<b.length;g++)f[b[g]]={},f.totals[b[g]]=0;for(var g=0;g<c.length;g++){e[c[g]]=0;for(var h=0;h<b.length;h++)f[b[h]][c[g]]=0}return $.each(currentMap.previousSeatData,function(a,g){$.each(c,function(a,c){b.indexOf(g.seatInfo.region)!=-1&&c in g.partyInfo&&(d+=g.partyInfo[c].total,e[c]+=g.partyInfo[c].total,f[g.seatInfo.region][c]+=g.partyInfo[c].total,f.totals[g.seatInfo.region]+=g.partyInfo[c].total)})}),$.each(e,function(a,b){e[a]=100*b/d}),e.other+=e.others,delete e.others,$.each(f,function(a,b){"totals"!=a&&$.each(c,function(b,c){f[a][c]/=.01*f.totals[a]}),f[a].other+=f[a].others,delete f[a].others}),delete f.totals,[e,f]},getUserChange:function(a,b,c){var d={};return $.each(c,function(e,f){var g={};$.each(a,function(d,f){g[d]=c[e][d]+(a[d]-b[d]),g[d]<0&&(g[d]=0)});var h=0;$.each(g,function(a,b){h+=b});var i=h/100;$.each(g,function(a,b){g[a]=b/i}),d[e]=g}),$.each(c,function(b,e){$.each(a,function(a,e){d[b][a]=d[b][a]-c[b][a]})}),d},seatAnalysis:function(a,b){$.each(currentMap.seatData,function(c,d){if(d.seatInfo.region in b){var e={};$.each(a[d.seatInfo.region],function(b,f){var g=0;b in currentMap.previousSeatData[c].partyInfo&&(g=100*currentMap.previousSeatData[c].partyInfo[b].total/currentMap.previousSeatData[c].seatInfo.turnout),
"other"==b&&"others"in currentMap.previousSeatData[c].partyInfo&&(g+=100*currentMap.previousSeatData[c].partyInfo.others.total/currentMap.previousSeatData[c].seatInfo.turnout);var h=a[d.seatInfo.region][b],i=g+h;i<.1*g&&(i=.1*g),0==g&&(i=0),e[b]=i});var f=0;for(var g in e)f+=e[g];var h=f/100;for(var g in e)e[g]/=h;var i=[];for(var g in e)i.push([g,e[g]]);i.sort(function(a,b){return a[1]-b[1]});var j=i.pop(),k=i.pop(),l=j[0],m=j[1]-k[1],n={seatInfo:{current:l,majority:parseInt(m*d.seatInfo.turnout/100),electorate:d.seatInfo.electorate,turnout:d.seatInfo.turnout,region:d.seatInfo.region},partyInfo:{}};$.each(e,function(a,b){b>0&&(n.partyInfo[a]={total:b*d.seatInfo.turnout/100,name:partylist[a]})}),currentMap.seatData[c].seatInfo=n.seatInfo,currentMap.seatData[c].partyInfo=n.partyInfo}}),currentMap.seatDataBackup=jQuery.extend(!0,{},currentMap.seatData),redistribute.resetInputs()},reset:function(){redistribute.resetInputs(),currentMap.seatData=jQuery.extend(!0,{},userInput.seatDataCopy),$(".map").remove(),pageLoadEssentials()}},voteTotals={data:[],totals:{},electorate:{},turnout:null,calculate:function(a){if("null"==a&&(a="unitedkingdom"),voteTotals.data=[],voteTotals.electorate=0,a in regionMap)var b=regionMap[a];else var b=[a];var c=[];for(var d in currentMap.seatData)b.indexOf(currentMap.seatData[d].seatInfo.region)!=-1&&(c.push(d),voteTotals.electorate+=currentMap.seatData[d].seatInfo.electorate);var e={name:"total",seats:c.length,change:null,votes:0,oldvotes:0,votePercent:null,votePercentChange:null},f={};$.each(partylist,function(a,d){var g={party:a,name:d,seats:0,change:0,votes:0,oldvotes:0,votePercent:null,votePercentChange:null};if($.each(c,function(b,c){currentMap.seatData[c].seatInfo.current==a&&(g.seats+=1),currentMap.previousSeatData[c].seatInfo.current==a&&(g.change+=1),a in currentMap.seatData[c].partyInfo&&(e.votes+=currentMap.seatData[c].partyInfo[a].total,g.votes+=currentMap.seatData[c].partyInfo[a].total),1==currentMap.election&&a in currentMap.previousSeatData[c].partyInfo&&(e.oldvotes+=currentMap.previousSeatData[c].partyInfo[a].total,g.oldvotes+=currentMap.previousSeatData[c].partyInfo[a].total)}),g.change=g.seats-g.change,"2017-600seat"==currentMap.name){var h=0;$.each(b,function(b,c){a in seatsPerRegion2015[c]&&(h+=seatsPerRegion2015[c][a])}),g.change=g.seats-h}f[a]=g}),voteTotals.totals=e,$.each(partylist,function(a,b){if(f[a].votePercent=(100*f[a].votes/e.votes).toFixed(2)/1,1==currentMap.election){var c=(100*f[a].oldvotes/e.oldvotes).toFixed(2)/1;f[a].votePercentChange=(f[a].votePercent-c).toFixed(2)/1}}),voteTotals.turnout=(100*e.votes/voteTotals.electorate).toFixed(2)/1,Object.keys(f.other).forEach(function(a){"name"!=a&&"party"!=a&&(f.other[a]+=f.others[a])}),f.other.votePercentChange=f.other.votePercentChange.toFixed(2)/1,delete f.others,$.each(f,function(a,b){b.votes>0&&voteTotals.data.push(b)}),$("#votetotalsarea").text(regionlist[a]),voteTotals.sortState={votes:"desc",seats:"desc",votePercent:"desc",votePercentChange:"desc"},voteTotals.tableSortHandler("votes")},reorder:function(a,b){"asc"==b?voteTotals.data.sort(function(b,c){return b[a]-c[a]}):"desc"==b&&voteTotals.data.sort(function(b,c){return c[a]-b[a]}),voteTotals.display()},activeSort:"votes",sortState:{},tableSortHandler:function(a){$("#votetotals-sort"+voteTotals.activeSort).removeClass("sort-active"),voteTotals.activeSort=a,voteTotals.reorder(voteTotals.activeSort,voteTotals.sortState[voteTotals.activeSort]),$("#votetotals-sort"+a).addClass("sort-active"),"desc"==voteTotals.sortState[a]?voteTotals.sortState[a]="asc":"asc"==voteTotals.sortState[a]&&(voteTotals.sortState[a]="desc")},display:function(){$("#votetotals-table-data").empty(),"election2015"==currentMap.name||"election2010"==currentMap.name||"election2017"==currentMap.name||"election2019"==currentMap.name?$("#votetotals-turnout").text("Turnout: "+voteTotals.turnout+"%"):$("#votetotals-turnout").text(" ");var a="</div><div>";$.each(voteTotals.data,function(b,c){var d=c.party,e="<div class='party-flair "+d+"'></div>"+c.name,f=c.seats,g=c.change,h=parseInt(c.votes),i=c.votePercent.toFixed(2),j=null;if(null!=c.votePercentChange)var j=c.votePercentChange.toFixed(2);var k=a;g>0?(k="</div><div style='color: green'>",g="+"+g):g<0&&(k="</div><div style='color: red'>");var l;j>=0?l="</div><div style='color: green'>"+j:j<0&&(l="</div><div style='color: red'>"+j);var m="<div><div>"+e+a+f+k+g+a+h.toLocaleString()+a+i+l+"</div></div>";$("#votetotals-table-data").append(m)});var b="</div><div class='lastrow'>";$("#votetotals-table-data").append("<div><div class='lastrow'>Totals"+b+voteTotals.totals.seats+b+"&nbsp;"+b+voteTotals.totals.votes.toLocaleString()+b+"&nbsp;"+b+"&nbsp;</div></div>");var c={true:"block",false:"none"};$("#votetotals-table-titles > div > div:nth-child(6)").css("display",c[currentMap.election]),$("#votetotals-table-data > div > div:nth-child(6)").css("display",c[currentMap.election])},getMajority:function(){var a=0,b=null;$.each(voteTotals.data,function(c,d){d.seats>a&&(a=d.seats,b=d.name)});var c;"650map.json"==currentMap.mapurl?c=650:"600map.json"==currentMap.mapurl&&(c=600);var d=c/2;if(a>d){var e=2*(a-d);$("#majoritytitle").text(b+" Majority: "+e)}else $("#majoritytitle").text("Hung Parliament")}};